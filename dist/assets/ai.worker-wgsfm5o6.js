var k=Object.defineProperty;var B=(l,v,u)=>v in l?k(l,v,{enumerable:!0,configurable:!0,writable:!0,value:u}):l[v]=u;var g=(l,v,u)=>B(l,typeof v!="symbol"?v+"":v,u);(function(){"use strict";var l=(a=>(a[a.EMPTY=0]="EMPTY",a[a.BLACK=1]="BLACK",a[a.WHITE=2]="WHITE",a))(l||{}),v=(a=>(a.EASY="EASY",a.MEDIUM="MEDIUM",a.HARD="HARD",a))(v||{});const u=15,E={FIVE:1e5,ACTIVE_FOUR:1e4,BLOCKED_FOUR:1e3,ACTIVE_THREE:1e3,BLOCKED_THREE:100,ACTIVE_TWO:100};class F{evaluate(e,n){const s=n===l.BLACK?l.WHITE:l.BLACK,t=this.getAllLines(e);let o=0,i=0;for(const c of t)o+=this.evaluateLine(c,n),i+=this.evaluateLine(c,s);return o-i}getAllLines(e){const n=[];for(let s=0;s<u;s++)n.push(e[s].join(""));for(let s=0;s<u;s++){let t="";for(let o=0;o<u;o++)t+=e[o][s];n.push(t)}for(let s=0;s<2*u-1;s++){let t="";for(let o=0;o<u;o++){const i=s-o;i>=0&&i<u&&(t+=e[o][i])}t.length>=5&&n.push(t)}for(let s=-14;s<u;s++){let t="";for(let o=0;o<u;o++){const i=o-s;i>=0&&i<u&&(t+=e[o][i])}t.length>=5&&n.push(t)}return n}evaluateLine(e,n){let s=0;const t=n.toString(),o=l.EMPTY.toString(),i=new RegExp(`${t}${t}${t}${t}${t}`,"g"),c=(e.match(i)||[]).length;s+=c*E.FIVE;const r=new RegExp(`${o}${t}${t}${t}${t}${o}`,"g"),f=(e.match(r)||[]).length;s+=f*E.ACTIVE_FOUR;const h=new RegExp(`${t}${t}${t}${t}`,"g");let X;for(;(X=h.exec(e))!==null;){const C=X.index,_=e[C-1],$=e[C+4],M=_===o,w=$===o;M&&w||(M||w)&&(s+=E.BLOCKED_FOUR)}const d=[`${o}${t}${t}${t}${o}`,`${o}${t}${t}${o}${t}${o}`,`${o}${t}${o}${t}${t}${o}`];for(const C of d){const _=new RegExp(C,"g"),$=(e.match(_)||[]).length;s+=$*E.ACTIVE_THREE}const T=new RegExp(`${t}${t}${t}`,"g");for(;(X=T.exec(e))!==null;){const C=X.index,_=e[C-1],$=e[C+3],M=_===o,w=$===o;M&&w||(M||w)&&(s+=E.BLOCKED_THREE)}const I=new RegExp(`${o}${t}${t}${o}`,"g"),O=(e.match(I)||[]).length;return s+=O*E.ACTIVE_TWO,s}}class R{constructor(){g(this,"DIRECTIONS",[{dr:0,dc:1},{dr:1,dc:0},{dr:1,dc:1},{dr:1,dc:-1}])}analyzePosition(e,n,s){const t={isFive:!1,activeFourCount:0,blockedFourCount:0,activeThreeCount:0,blockedThreeCount:0,activeTwoCount:0,blockedTwoCount:0,isActiveFour:!1};for(const o of this.DIRECTIONS){const i=this.getLine(e,n,o,s),c=this.recognizePattern(i);this.mergePattern(t,c)}return t}getLine(e,n,s,t){const o=t===l.BLACK?l.WHITE:l.BLACK;let i="";for(let c=-6;c<=6;c++){const r=n.row+c*s.dr,f=n.col+c*s.dc;r<0||r>=u||f<0||f>=u?i+="B":e[r][f]===t?i+="X":e[r][f]===o?i+="O":i+="_"}return i}recognizePattern(e){const n={};if(/XXXXX/.test(e))return n.isFive=!0,n;/_XXXX_/.test(e)&&(n.activeFourCount=1,n.isActiveFour=!0);const s=[/BXXXX_/,/_XXXXB/,/OXXXX_/,/_XXXXO/,/XX_XX/,/XXX_X/,/X_XXX/];for(const r of s)r.test(e)&&(n.blockedFourCount=(n.blockedFourCount||0)+1);const t=[/_XXX_/,/_XX_X_/,/_X_XX_/];for(const r of t)r.test(e)&&(n.activeThreeCount=(n.activeThreeCount||0)+1);const o=[/BXXX_/,/_XXXB/,/OXXX_/,/_XXXO/,/BXX_X/,/X_XXB/,/OXX_X/,/X_XXO/];for(const r of o)r.test(e)&&(n.blockedThreeCount=(n.blockedThreeCount||0)+1);const i=[/_XX_/,/_X_X_/];for(const r of i)r.test(e)&&(n.activeTwoCount=(n.activeTwoCount||0)+1);const c=[/BXX_/,/_XXB/,/OXX_/,/_XXO/,/BX_X/,/X_XB/];for(const r of c)r.test(e)&&(n.blockedTwoCount=(n.blockedTwoCount||0)+1);return n}mergePattern(e,n){n.isFive&&(e.isFive=!0),n.isActiveFour&&(e.isActiveFour=!0),e.activeFourCount+=n.activeFourCount||0,e.blockedFourCount+=n.blockedFourCount||0,e.activeThreeCount+=n.activeThreeCount||0,e.blockedThreeCount+=n.blockedThreeCount||0,e.activeTwoCount+=n.activeTwoCount||0,e.blockedTwoCount+=n.blockedTwoCount||0}}const p=a=>a.map(e=>[...e]),A=a=>{const e=Math.floor(a/2);return{row:e,col:e}};class x{constructor(e=v.MEDIUM){g(this,"evaluator");g(this,"patternMatcher");g(this,"maxDepth");g(this,"searchRadius");this.evaluator=new F,this.patternMatcher=new R,this.maxDepth=3,this.searchRadius=2,this.setDifficulty(e)}setDifficulty(e){switch(e){case v.EASY:this.maxDepth=2,this.searchRadius=1;break;case v.MEDIUM:this.maxDepth=3,this.searchRadius=2;break;case v.HARD:this.maxDepth=4,this.searchRadius=2;break}}getBestMove(e,n){const s=Date.now();if(this.isFirstMove(e))return this.getOpeningMove();const t=this.getCandidatePositions(e);if(t.length===0)return A(u);const o=this.checkCriticalMoves(e,n);if(o)return console.log(`AI找到关键位置: (${o.row}, ${o.col}), 耗时: ${Date.now()-s}ms`),o;let i=-1/0,c=t[0],r=-1/0;const f=1/0;for(const X of t){const d=p(e);d[X.row][X.col]=n;const T=this.minimax(d,this.maxDepth-1,!1,r,f,n);T>i&&(i=T,c=X),r=Math.max(r,T)}const h=Date.now()-s;return console.log(`AI思考完成: (${c.row}, ${c.col}), 分数: ${i}, 耗时: ${h}ms, 候选数: ${t.length}`),c}minimax(e,n,s,t,o,i){if(n===0)return this.evaluator.evaluate(e,i);const c=this.getCandidatePositions(e);if(c.length===0)return this.evaluator.evaluate(e,i);const r=s?i:this.getOpponent(i);if(s){let f=-1/0;for(const h of c){const X=p(e);X[h.row][h.col]=r;const d=this.minimax(X,n-1,!1,t,o,i);if(f=Math.max(f,d),t=Math.max(t,d),o<=t)break}return f}else{let f=1/0;for(const h of c){const X=p(e);X[h.row][h.col]=r;const d=this.minimax(X,n-1,!0,t,o,i);if(f=Math.min(f,d),o=Math.min(o,d),o<=t)break}return f}}getCandidatePositions(e){const n=[],s=Array(u).fill(!1).map(()=>Array(u).fill(!1)),t=this.searchRadius;for(let o=0;o<u;o++)for(let i=0;i<u;i++)if(e[o][i]!==l.EMPTY)for(let c=-t;c<=t;c++)for(let r=-t;r<=t;r++){const f=o+c,h=i+r;f>=0&&f<u&&h>=0&&h<u&&e[f][h]===l.EMPTY&&!s[f][h]&&(s[f][h]=!0,n.push({row:f,col:h}))}return n}checkCriticalMoves(e,n){const s=this.getOpponent(n),t=this.findWinningMove(e,n);if(t)return t;const o=this.findWinningMove(e,s);if(o)return o;const i=this.findActiveFour(e,n);if(i)return i;const c=this.findActiveFour(e,s);return c||null}findWinningMove(e,n){const s=this.getCandidatePositions(e);for(const t of s){const o=p(e);if(o[t.row][t.col]=n,this.patternMatcher.analyzePosition(o,t,n).isFive)return t}return null}findActiveFour(e,n){const s=this.getCandidatePositions(e);for(const t of s){const o=p(e);if(o[t.row][t.col]=n,this.patternMatcher.analyzePosition(o,t,n).isActiveFour)return t}return null}isFirstMove(e){return e.every(n=>n.every(s=>s===l.EMPTY))}getOpeningMove(){return A(u)}getOpponent(e){return e===l.BLACK?l.WHITE:l.BLACK}}const m=new x;self.onmessage=a=>{const{type:e}=a.data;switch(e){case"INIT":a.data.type==="INIT"&&m.setDifficulty(a.data.difficulty);break;case"GET_MOVE":if(a.data.type==="GET_MOVE"){const{board:n,player:s,difficulty:t}=a.data;t&&m.setDifficulty(t);const o=m.getBestMove(n,s);self.postMessage(o)}break}}})();
